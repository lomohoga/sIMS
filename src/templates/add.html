{% extends "base.html" %}

{% block main %}

<div id="content-top">
    <h1 class="main-header">Item Addition</h1>
</div>

<div id="add-table" class="table-wrapper">
    <div class="table-main inventory-table">
        <div class="table-header">
            <div class="table-row">
                <div>Code</div>
                <div>Name</div>
                <div>Description</div>
                <div>Shelf Life</div>
                <div>Unit Price</div>
                <div>Available Quantity</div>
                <div>Unit</div>
                <div></div>
            </div>
        </div>
        <div class="table-body">
            <div class="table-row" id="add-row">
                <div>
                    <button role="button"><i class="bi bi-plus-circle"></i>Add item</button>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="add">
    <input type="submit" id="add-btn" value="Add items" name="add-btn" disabled>
</form>

<script>
    function disableButton () {
        document.querySelector("#add-btn").disabled =
            // Disable if there are no rows in table
            document.querySelector("#add-table .table-body").childElementCount === 1
            // Disable if at least one row has no item code
            || Array.from(document.querySelectorAll("#add-table .table-body .table-row:not(#add-row) > :first-child input")).some(x => x.value === '')
            // Disable if at least one input box is invalid
            || Array.from(document.querySelectorAll("#add-table input")).some(x => !x.checkValidity());
    }

    function addRow () {
        let row = document.createElement("div");
        row.classList.add("table-row");

        for (let i = 0; i < 7; i++) {
            let el;

            if (i === 2) {
                el = document.createElement("textarea");
                el.rows = 1;
            } else {
                el = document.createElement("input");
                el.type = (i === 0 || i === 1 || i === 6) ? "text" : "number";
                if (i !== 0 && i !== 1 && i !== 6) el.min = 0;

                if (i === 0) el.maxLength = 8;
                if (i === 1) el.maxLength = 15;
                if (i === 2) el.maxLength = 100;
                if (i === 4) el.step = 0.01;
                if (i === 5) el.step = 1;
                if (i === 6) el.maxLength = 15;
            }

            let wrapper = document.createElement("div");

            if (i === 0) wrapper.classList.add("mono");
            if (i === 2) wrapper.classList.add("left");
            if (i === 4 || i === 5) wrapper.classList.add("right");
            if (i === 4 || i === 5) wrapper.classList.add("tabnum");

            wrapper.appendChild(el);
            
            if (i === 3) {
                let sel = document.createElement("select");

                for (let x in timeConv) {
                    let op = document.createElement("option");
                    op.value = timeConv[x];
                    op.innerHTML = x;
                    sel.appendChild(op);
                }
                
                sel.value = 1;
                sel.addEventListener("input", () => {
                    let op = sel.previousElementSibling;

                    if (sel.value === '-1') {
                        op.classList.add("hide");
                        sel.classList.add("extend");
                    }
                    else {
                        op.classList.remove("hide");
                        sel.classList.remove("extend");
                    }
                });
                wrapper.appendChild(sel);
                wrapper.classList.add("shelf-life");
            }

            row.appendChild(wrapper);
        }

        let e = document.createElement("div");
        let b = document.createElement("button");
        b.type = "button";
        b.role = "button";
        b.innerHTML = "<i class='bi bi-dash-circle'></i><i class='bi bi-dash-circle-fill'></i>"
        b.classList.add("delete-row");
        e.appendChild(b);
        row.append(e);

        b.addEventListener("click", () => document.querySelector("#add-table .table-body").removeChild(b.parentElement.parentElement));

        document.querySelector("#add-table .table-body").insertBefore(row, document.querySelector("#add-row"));
        disableButton();
    }

    document.querySelector("#add").addEventListener("submit", e => {
        e.preventDefault();

        let values = [];

        for (let row of Array.from(document.querySelectorAll("#add-table .table-body .table-row:not(#add-row)"))) {
            let v = [];
            Array.from(row.children).forEach((x, i) => {
                if (i === 3) v.push(x.lastChild.value === '-1' ? -1 : Math.round(+x.firstChild.value * +x.lastChild.value));
                else if (i === 4 || i === 5) v.push(+x.firstChild.value);
                else if (i !== 7) v.push(x.firstChild.value);
            });
            values.push(v);
        }

        fetch("{{ url_for('add_items') }}", {
            "method": "POST",
            "headers": {
                "Content-Type": "application/json"
            },
            "body": JSON.stringify({ "values": values })
        }).then(d => {
            if (d.status === 200) window.location = "{{ url_for('inventory') }}";
            if(d.status === 403) return d.text().then((html) => {
                document.body.innerHTML = html     
            })
        });

        disableButton();
    });

    document.querySelector("#add-table").addEventListener("input", disableButton);

    document.querySelector("#add-row").addEventListener("click", addRow);
</script>

{% endblock %}