{% extends "base.html" %}

{% block main %}

<div id="content-top">
    <h1 class="main-header">Item Update</h1>

    <form id="search">
        <input type="search" id="search-box" placeholder="Search item&hellip;" name="keyword">
        <input type="submit" id="search-btn" value="Search" name="search-btn">
    </form>
</div>

<div id="item-search" class="table-wrapper">
    <div class="table-main inventory-table">
        <div class="table-header">
            <div class="table-row">
                <div>Code</div>
                <div>Name</div>
                <div>Description</div>
                <div><span>Shelf Life<br><span style="font-weight: initial; font-style: italic; font-size: 80%;">(in hours)</span></span></div>
                <div>Unit Price</div>
                <div>Available Quantity</div>
                <div>Unit</div>
                <div></div>
            </div>
        </div>
        <div class="table-body">
            <div class="table-row table-loading hide">
                <div>Please wait&hellip;</div>
            </div>
            <div class="table-row table-empty hide">
                <div>No items found.</div>
            </div>
        </div>
    </div>
</div>

<div id="updated-items" class="table-wrapper">
    <div class="table-main inventory-table">
        <div class="table-header">
            <div class="table-row">
                <div>Code</div>
                <div>Name</div>
                <div>Description</div>
                <div>Shelf Life</div>
                <div>Unit Price</div>
                <div>Available Quantity</div>
                <div>Unit</div>
                <div></div>
            </div>
        </div>
        <div class="table-body"> </div>
    </div>
</div>

<form id="update">
    <input type="submit" id="update-btn" value="Update selected items" name="update-btn" disabled>
</form>

<script>
    function addRow () {
        let row = document.createElement("div");
        row.classList.add("table-row");

        for (let i = 0; i < 7; i++) {
            let el;

            if (i === 2) {
                el = document.createElement("textarea");
                el.rows = 1;
            } else {
                el = document.createElement("input");
                el.type = (i === 0 || i === 1 || i === 6) ? "text" : "number";
                if (i !== 0 && i !== 1 && i !== 6) el.min = 0;

                if (i === 0) el.maxLength = 8;
                if (i === 1) el.maxLength = 15;
                if (i === 2) el.maxLength = 100;
                if (i === 4) el.step = 0.01;
                if (i === 5) el.step = 1;
                if (i === 6) el.maxLength = 15;
            }

            let wrapper = document.createElement("div");

            if (i === 0) wrapper.classList.add("mono");
            if (i === 2) wrapper.classList.add("left");
            if (i === 4 || i === 5) wrapper.classList.add("right");
            if (i === 4 || i === 5) wrapper.classList.add("tabnum");

            wrapper.appendChild(el);
            
            if (i === 3) {
                let sel = document.createElement("select");

                for (let x in timeConv) {
                    let op = document.createElement("option");
                    op.value = timeConv[x];
                    op.innerHTML = x;
                    sel.appendChild(op);
                }
                
                sel.value = 1;
                sel.addEventListener("input", () => {
                    let op = sel.previousElementSibling;

                    if (sel.value === '-1') {
                        op.classList.add("hide");
                        sel.classList.add("extend");
                    }
                    else {
                        op.classList.remove("hide");
                        sel.classList.remove("extend");
                    }
                });
                wrapper.appendChild(sel);
                wrapper.classList.add("shelf-life");
            }

            row.appendChild(wrapper);
        }

        let e = document.createElement("div");
        let b = document.createElement("button");
        b.type = "button";
        b.role = "button";
        b.innerHTML = "<i class='bi bi-dash-circle'></i><i class='bi bi-dash-circle-fill'></i>"
        b.classList.add("delete-row");
        e.appendChild(b);
        row.append(e);

        return row;
    }

    function selectItem (row) {
        let newRow = addRow();

        for (let i = 0; i < 7; i++) {
            if (i === 2) newRow.children[i].querySelector("textarea").value = row.children[i].innerHTML;
            else if (i === 3) {
                if (row.children[i].innerHTML === '\u2014') {
                    newRow.children[i].querySelector("select").value = -1;
                    newRow.children[i].querySelector("input").classList.add("hide");
                    newRow.children[i].querySelector("select").classList.add("extend");
                } else newRow.children[i].querySelector("input").value = row.children[i].innerHTML.replaceAll(",", "");
            }
            else if (i === 4) newRow.children[i].querySelector("input").value = parseFloat(row.children[i].querySelector(".currency :last-child").innerHTML.replaceAll(",", ""));
            else if (i === 5) newRow.children[i].querySelector("input").value = row.children[i].innerHTML.replaceAll(",", "");
            else newRow.children[i].querySelector("input").value = row.children[i].innerHTML;
        }
        
        newRow.lastChild.querySelector("button").addEventListener("click", () => {
            document.querySelector("#updated-items .table-body").removeChild(newRow);
            let r = Array.from(document.querySelectorAll("#item-search .table-body .table-row")).filter(x => x.firstChild.innerHTML === newRow.querySelector(".hidden").innerHTML);
            if (r.length > 0) r[0].lastChild.querySelector("button").disabled = false;
            toggleUpdateDisabled();
        });

        let inv = document.createElement("div");
        inv.classList.add("hidden");
        inv.innerHTML = row.children[0].innerHTML;
        newRow.appendChild(inv);

        let b = document.querySelector("#updated-items .table-body");
        b.insertBefore(newRow, b.firstChild);
        row.lastChild.querySelector("button").disabled = true;
        toggleUpdateDisabled();
    }

    function disableButtons () {
        if (document.querySelector("#updated-items .table-body").childElementCount > 0) {
            let codes = Array.from(document.querySelectorAll("#updated-items .table-body .table-row > .hidden")).map(x => x.innerHTML);
            Array.from(document.querySelectorAll("#item-search .table-body .table-row")).filter(x => codes.includes(x.firstChild.innerHTML)).forEach(x => x.lastChild.querySelector("button").disabled = true);
        }
    }

    function toggleUpdateDisabled () {
        document.querySelector("#update-btn").disabled = document.querySelector("#updated-items .table-body").childElementCount === 0;
    }

    document.querySelector("#search").addEventListener("submit", e => {
        e.preventDefault();
        populateTable(document.querySelector("#item-search .table-body"), document.querySelector("#search-box").value, "item-search");
    });

    window.addEventListener("load", () => populateTable(document.querySelector("#item-search .table-body"), document.querySelector("#search-box").value, "item-search"));

    document.addEventListener("tablerefresh", () => {
        Array.from(document.querySelectorAll("#item-search .table-body .table-row > :last-child button")).forEach(x => {
            x.addEventListener("click", () => selectItem(x.parentElement.parentElement));
        });
        toggleUpdateDisabled();
        disableButtons();
    });

    document.querySelector("#update").addEventListener("submit", e => {
        e.preventDefault();
        
        let obj = {};
        for (let row of Array.from(document.querySelectorAll("#updated-items .table-body .table-row:not(#add-row)"))) {
            let v = [];
            Array.from(row.children).forEach((x, i) => {
                if (i < 8) {
                    if (i === 3) v.push(x.lastChild.value === '-1' ? -1 : Math.round(+x.firstChild.value * +x.lastChild.value));
                    else if (i === 4 || i === 5) v.push(+x.firstChild.value);
                    else if (i !== 7) v.push(x.firstChild.value);
                }
            });
            obj[row.children[8].innerHTML] = v;
        }
        
        fetch("{{ url_for('update_items') }}", {
            "method": "POST",
            "headers": {
                "Content-Type": "application/json"
            },
            "body": JSON.stringify({ "values": obj })
        }).then(d => {
            if (d.status === 200) window.location = "{{ url_for('inventory') }}";
        });
    })
</script>

{% endblock %}