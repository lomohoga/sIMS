<!DOCTYPE html>
<html lang="en">
    <head>
        <title>sIMS</title>
        <link rel="icon" href="{{ url_for('static', filename = 'favicon.png') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename = 'fonts/fonts.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename = 'style.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename = 'style_table.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename = 'style_inventory.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename = 'style_request.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename = 'style_dialog.css') }}">
        <script src="{{ url_for('static', filename = 'script_table.js') }}"></script>
    </head>

    <div id="modal-change-password" class="modal-wrapper">
        <div class="modal-background"></div>
        <div class="modal-main">
            <button type="button" role="button" class="modal-close">&times;</button>
            <h1>Change password</h1>
            <div id="modal-change-password-1">
                <form id="form-change-password">
                    <span class="form-grid">
                        <label for="old-password">Enter old password:</label>
                        <input id="old-password" type="password" minlength="8" maxlength="12">
                        <label for="new-password">Enter new password:</label>
                        <input id="new-password" type="password" minlength="8" maxlength="12">
                        <label for="confirm-password">Re-enter new password:</label>
                        <input id="confirm-password" type="password" minlength="8" maxlength="12">
                    </span>
                    <span id="password-note">
                        <p><b>NOTE:</b> Your new password must contain the following:</p>
                        <ul>
                            <li>8 to 12 characters</li>
                            <li>at least one capital letter</li>
                            <li>at least one small letter</li>
                            <li>at least one digit</li>
                        </ul>
                    </span>
                    <span>
                        <p class="form-msg"></p>
                        <input type="submit" value="Submit" disabled>
                    </span>
                </form>
            </div>
            <div id="modal-change-password-2">
                <p>Your password has been changed successfully. You will be logged out of your account in a few seconds.</p>
            </div>
        </div>
    </div>

    <div id="modal-change-email" class="modal-wrapper">
        <div class="modal-background"></div>
        <div class="modal-main">
            <button type="button" role="button" class="modal-close">&times;</button>
            <h1>Change email address</h1>
            <div id="modal-change-email-1">
                <form id="form-change-email">
                    <span class="form-grid">
                        <label for="password">Enter password:</label>
                        <input id="password" type="password" minlength="8" maxlength="12">
                        <label for="new-email">Enter new email address:</label>
                        <input id="new-email" type="email" placeholder="example@gmail.com" pattern="^([0-9a-z]|([0-9a-z][\.\-_\+]{1}[0-9a-z]))+@gmail.com$">
                    </span>
                    <p style="font-size: smaller;"><i><b>NOTE:</b> Due to technical restrictions, only Gmail emails are accepted at this time.</i></p>
                    <span>
                        <p class="form-msg"></p>
                        <input type="submit" value="Submit" disabled>
                    </span>
                </form>
            </div>
            <div id="modal-change-email-2">
                <p>The email associated with your account has been changed successfully. You will be logged out of your account in a few seconds.</p>
            </div>
        </div>
    </div>

    <body>
        <header>
            <div id="home">
                <a href = "{{ url_for('index') }}">
                    <h1 id="title"><span>s</span>IMS</h1>
                </a>
            </div>

            <div id="profile">
                <button type="button" role="button">
                    <span class="info" id="profile-name">{{ session['user']['FirstName'] }} {{ session['user']['LastName'] }}</span>
                    <br>
                    <span class="info" id="profile-role">{{ session['user']['RoleName'] }}</span>
                </button>

                <div id="profile-dropdown">
                    <button type="button" role="button" id="change-password">Reset password</a>
                    <button type="button" role="button" id="change-email">Change email address</a>
                </div>
            </div>

            <!-- <dialog id="change-password-dialog">
                <div id="step1">
                    <h1>Verify user</h1>

                    <div>
                        <label for="old-password">Enter old password:</label>
                        <br>
                        <input type="password" id="old-password" name="old-password" autofocus>
                        <p class='message' id="step1-message"></p>
                    </div>
                    
                    <form id="old-password-form">
                        <input type="submit" value="Submit" disabled>
                    </form>
                </div>

                <div id="step2">
                    <h1>Reset password</h1>
    
                    <div>
                        <p>Password must have <em><b>8 to 12 alphanumeric characters</b></em>.</p>
                        <label for="new-password">Enter new password:</label>
                        <div style="height: 20%">
                            <input type="password" id="new-password" name="new-password" pattern="(?=.*[a-zA-Z0-9]).{8,12}" required>
                        </div>
                        <br>
    
                        <label for="new-password2" style="margin-top: 20px">Enter new password again:</label>
                        <div>
                            <input type="password" id="new-password2" name="new-password2" required>
                        </div>
                        <p class='message' id="step2-message"></p>
                    </div>
    
                    <form id="password-form">
                        <input type="submit" value="Submit" id="submit" disabled>
                    </form>
                </div>

                <div id="step3">
                    <div class="password-reset-success">
                        <h1 style="text-align: center;">Password reset successfully &#127881;</h1>
                        <form method="dialog">
                            <input type="submit" value="Close">
                        </form>
                    </div>
                </div>
            </dialog>

            <dialog id="change-email-dialog">
                <div id="step1">
                    <h1>Change email</h1>
                    <p>Email must have a <em><b>gmail.com</b></em> domain.</p>

                    <div>
                        <label for="old-password2">Enter your password:</label>
                        <br>
                        <input type="password" id="old-password2" name="old-password" autofocus>
                        <p class='message' id="step3-message"></p>
                    </div>

                    <div style="margin-top: 20px; height: 45%;">
                        <label for="new-email">Enter new email address:</label>
                        <br>
                        <input type="email" id="new-email" name="new-email" placeholder="{{ session['user']['Email'] }}" maxlength="50" title="Email address must have a gmail.com domain">
                        <p class='message' id="step3-message"></p>
                    </div>
                    
                    <form id='new-email-form' style="align-self: flex-end;">
                        <input type="submit" value="Submit" id="submit" disabled>
                    </form>
                </div>

                <div id="step2">
                    <div class="password-reset-success">
                        <h1 style="text-align: center;">Email changed successfully &#127881;</h1>
                        <form method="dialog">
                            <input type="submit" value="Close">
                        </form>
                    </div>
                </div>
            </dialog> -->
        </header>

        <div id="sidebar">
            <nav>
                <a class="link {{ 'active' if active == 'inventory' }}" href="{{ url_for('bp_inventory.inventory') }}">Inventory</a>
                {% if session['user']['RoleID'] == 1 %}
                    <a class="link {{ 'active' if active == 'deliveries' }}" href="{{ url_for('bp_delivery.deliveries') }}">Deliveries</a>
                {% endif %}
                <a class="link {{ 'active' if active == 'requests' }}" href="{{ url_for('bp_request.requests') }}">{{ 'My' if session['user']['RoleID'] == 2 else 'Item' }} Requests</a>
                {% if session['user']['RoleID'] == 0 %}
                    <a class="link {{ 'active' if active == 'users' }}" href="{{ url_for('bp_user.show_users') }}">Users</a>
                {% endif %}
                <a class="link logout" href="{{ url_for('bp_auth.logout') }}">Log out</a>
            </nav>
            
            <footer>
                <p>
                    &copy; 2022&ndash;2023 sIMS<br>
                    All rights reserved.
                </p>
            </footer>
        </div>

        <main>
            {% block main %}
            {% endblock %}
        </main>
    </body>
</html>

<script>
    function showModal (modal) {
        modal.classList.add("show");
    }

    function hideModal (modal) {
        modal.classList.remove("show");
        modal.querySelector("form").reset();
    }

    function changeEmailValidity () {
        let t = document.querySelector("#form-change-email");
        t.querySelector("input[type=submit]").disabled = !(t.checkValidity()
                                                           && Array.prototype.every.call(t.querySelectorAll("input"), x => x.value !== '')
                                                           && [/[A-Z]+/, /[a-z]+/, /[0-9]+/].map(x => t.querySelector("input[type=password]").value.match(x) !== null).every(x => x));
    }

    function changePasswordValidity () {
        let t = document.querySelector("#form-change-password");

        t.querySelector("input[type=submit]").disabled = !(t.checkValidity()
                                                           && Array.prototype.every.call(t.querySelectorAll("input"), x => x.value !== '')
                                                           && Array.prototype.map.call(document.querySelectorAll("#new-password, #confirm-password"), x => [/[A-Z]+/, /[a-z]+/, /[0-9]+/].map(y => x.value.match(y) !== null).every(y => y)).every(x => x));
    }

    // modal open & close events
    document.querySelector("#modal-change-password").addEventListener("modalopen", () => {
        showModal(document.querySelector("#modal-change-password"));
        document.querySelector("#modal-change-password-1").style.display = "";
        document.querySelector("#modal-change-password-2").style.display = "none";
        document.querySelector("#form-change-password").reset();
        document.querySelector("#form-change-password input:first-of-type").focus();
        document.querySelector('#form-change-password .form-msg').classList.remove("error");
        document.querySelector('#form-change-password .form-msg').innerText = '';
    });

    document.querySelector("#modal-change-password").addEventListener("modalclose", () => {
        hideModal(document.querySelector("#modal-change-password"));
    });

    document.querySelector("#modal-change-email").addEventListener("modalopen", () => {
        showModal(document.querySelector("#modal-change-email"));
        document.querySelector("#modal-change-email-1").style.display = "";
        document.querySelector("#modal-change-email-2").style.display = "none";
        document.querySelector("#form-change-email").reset();
        document.querySelector("#form-change-email input:first-of-type").focus();
        document.querySelector('#form-change-email .form-msg').classList.remove("error");
        document.querySelector('#form-change-email .form-msg').innerText = '';
    });

    document.querySelector("#modal-change-email").addEventListener("modalclose", () => {
        hideModal(document.querySelector("#modal-change-email"));
    });

    document.querySelector("#change-password").addEventListener("click", () => {
        document.querySelector("#modal-change-password").dispatchEvent(new Event("modalopen"));
    });

    document.querySelector("#change-email").addEventListener("click", () => {
        document.querySelector("#modal-change-email").dispatchEvent(new Event("modalopen"));
    });

    document.querySelectorAll(".modal-background").forEach(x => {
        x.addEventListener("click", () => x.dispatchEvent(new Event("modalclose", { bubbles: true })));
        x.addEventListener("keydown", e => {
            if (e.key === 'Escape') x.dispatchEvent(new Event("modalclose", { bubbles: true }));
        });
    });

    document.querySelectorAll(".modal-close").forEach(x => {
        x.addEventListener("click", () => x.dispatchEvent(new Event("modalclose", { bubbles: true })));
    });

    // modal form events
    document.querySelector("#form-change-email").addEventListener("input", () => {
        changeEmailValidity();
        document.querySelector("#form-change-email .form-msg").innerText = '';
        document.querySelector("#form-change-email .form-msg").classList.remove("error");
    });

    document.querySelector("#form-change-email").addEventListener("submit", e => {
        e.preventDefault();

        document.querySelector("#modal-change-email .form-msg").innerText = "Please wait\u2026";

        fetch("{{ url_for('bp_user.change_email') }}", {
            "method": "POST",
            "headers": {
                "Content-Type": "application/json"
            },
            "body": JSON.stringify({
                "password": document.querySelector('#password').value,
                "email": document.querySelector('#new-email').value
            })
        }).then(async d => {
            if (d.status === 200) {
                document.querySelector("#modal-change-email-1").style.display = "none";
                document.querySelector("#modal-change-email-2").style.display = "initial";
                window.setTimeout(() => window.location = "{{ url_for('bp_auth.logout') }}", 3000);
            } else {
                document.querySelector("#form-change-email").reset();
                document.querySelector('#form-change-email .form-msg').classList.add("error");
                document.querySelector('#form-change-email .form-msg').innerText = (await d.json())['error'];
            }
        });

        changeEmailValidity();
    });

    document.querySelector("#form-change-password").addEventListener("input", () => {
        changePasswordValidity();
        document.querySelector("#form-change-password .form-msg").innerText = '';
        document.querySelector("#form-change-password .form-msg").classList.remove("error");
    });

    document.querySelector("#form-change-password").addEventListener("submit", e => {
        e.preventDefault();

        if (document.querySelector("#new-password").value !== document.querySelector("#confirm-password").value) {
            document.querySelector("#form-change-password").reset();
            document.querySelector("#form-change-password .form-msg").innerText = "Your new password does not match the confirmation. Please make sure you have entered your new password correctly.";
            document.querySelector("#form-change-password .form-msg").classList.add("error");
        } else {
            document.querySelector("#modal-change-password .form-msg").innerText = "Please wait\u2026";

            fetch("{{ url_for('bp_user.change_password') }}", {
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json"
                },
                "body": JSON.stringify({
                    "old-password": document.querySelector('#old-password').value,
                    "new-password": document.querySelector('#new-password').value
                })
            }).then(async d => {
                if (d.status === 200) {
                    document.querySelector("#modal-change-password-1").style.display = "none";
                    document.querySelector("#modal-change-password-2").style.display = "initial";
                    window.setTimeout(() => window.location = "{{ url_for('bp_auth.logout') }}", 3000);
                } else {
                    document.querySelector("#form-change-password").reset();
                    document.querySelector('#form-change-password .form-msg').classList.add("error");
                    document.querySelector("#form-change-password .form-msg").innerText = (await d.json())['error'];
                }
            });
        }

        changePasswordValidity();
    });

    // profile dropdown event listeners
    document.querySelector("#profile button").addEventListener('click', e => {
        e.stopPropagation();
        document.querySelector("#profile-dropdown").classList.add("show");
    });

    window.addEventListener("click", e => {
        if (e.target !== document.querySelector("#profile-dropdown")) document.querySelector("#profile-dropdown").classList.remove("show");
    });

    window.addEventListener("keydown", e => {
        if (e.key === 'Escape') {
            document.querySelector("#profile-dropdown").classList.remove("show");
        }
    })
</script>