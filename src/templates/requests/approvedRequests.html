{% extends "base.html" %}

{% block main %}

<div id="content-top">
    <h1 class="main-header">
        Approved Requests
    </h1>

    <div id="inputs">
        <div>
            <form id="search">
                <input type="search" id="search-box" placeholder="Search requests&hellip;" name="keyword" autofocus>
                <input type="submit" id="search-btn" value="Search" name="search-btn">
            </form>
        </div>
    </div>
</div>

<div class="table-wrapper">
    <div class="table-main request-table approved-table">
        <div class="table-header">
            <div class="table-row">
                <div class="table-sortable">
                    <button role="button" class="sort-btn">
                        RID
                        <i class="bi bi-chevron-expand"></i>
                    </button>
                </div>
                <div class="table-sortable">
                    <button role="button" class="sort-btn">
                        Requested By
                        <i class="bi bi-chevron-expand"></i>
                    </button>
                </div>
                <div class="table-sortable">
                    <button role="button" class="sort-btn">
                        Request Date
                        <i class="bi bi-chevron-expand"></i>
                    </button>
                </div>
                <div>Status</div>
                <div>Item ID</div>
                <div>Item Name</div>
                <div>Item Description</div>
                <div>Request Quantity</div>
                <div>Available Quantity</div>
                <div>Unit</div>
                <div>Available?</div>
                <div>Ready for Issue</div>
            </div>
        </div>
        <div class="table-body">
            <div class="table-loading table-row hide">
                <div>Please wait&hellip;</div>
            </div>
            <div class="table-empty table-row hide">
                <div>No items found.</div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSort = [0, true];

    document.querySelectorAll(".request-table .sort-btn").forEach(x => {
        const p = x.parentElement;
        x.addEventListener("click", () => {
            currentSort = sortTable(document.querySelector(".request-table"), Array.prototype.indexOf.call(p.parentElement.children, p), currentSort, { shelfLife: x.innerText.includes("Shelf Life"), date: x.innerText.includes("Date") });
        });
    });
    
    document.querySelector("#search").addEventListener("submit", e => {
        e.preventDefault();
        populateRequests(document.querySelector(".request-table .table-body"), document.querySelector("#search-box").value, "approved");

        let oldSym = document.querySelector(`.request-table .table-header .table-row > :nth-child(${currentSort[0] + 1}) .bi`);
        oldSym.classList.remove(`bi-chevron-${currentSort[1] ? "up" : "down"}`);
        oldSym.classList.add("bi-chevron-expand");

        currentSort = [0, true];

        let newSym = document.querySelector(".request-table .table-header .table-row > :nth-child(1) .bi");
        newSym.classList.remove("bi-chevron-expand");
        newSym.classList.add("bi-chevron-up");
    });

    document.addEventListener("tablerefresh", () => {
        currentSort = [0, true];

        if (document.querySelector(".request-table .bi-chevron-up, .request-table .bi-chevron-down")) document.querySelector(".request-table .bi-chevron-up, .request-table .bi-chevron-down").classList.add("bi-chevron-expand");
        if (document.querySelector(".request-table .bi-chevron-up")) document.querySelector(".request-table .bi-chevron-up").classList.remove("bi-chevron-up");
        if (document.querySelector(".request-table .bi-chevron-down")) document.querySelector(".request-table .bi-chevron-down").classList.remove("bi-chevron-down");
        document.querySelector(".request-table .bi-chevron-expand").classList.add("bi-chevron-up");
        document.querySelector(".request-table .bi-chevron-expand").classList.remove("bi-chevron-expand");

        document.querySelectorAll(".available-btn").forEach(x => x.addEventListener("click", () => {
            amount = Number(prompt("Enter amount of the item to be released:"));
            requestQuantity = Number(x.parentElement.previousElementSibling.previousElementSibling.previousElementSibling.innerText); // Change if layout is changed
            if (amount > requestQuantity) alert("Please enter amount equal or less than the requested amount.")
            else if (amount != 0) {
                let reqDetails = x.value.split(' ');
                issueRequestItem(1, amount, reqDetails[0], reqDetails[1]);
                window.location = encodeURI(`/requests/approvedRequests`);
            }
        }));

        document.querySelectorAll(".not-available-btn").forEach(x => x.addEventListener("click", () => {
            if (confirm("Are you sure the item is unavailable?")) {
                let reqDetails = x.value.split(' ');
                issueRequestItem(0, 0, reqDetails[0], reqDetails[1]);
                window.location = encodeURI(`/requests/approvedRequests`);
            }
        }));

        document.querySelectorAll(".issue-btn").forEach(x => x.addEventListener("click", () => {
            if (confirm("Are you sure want to issue this request?")) {
                issueRequest(x.value);
                window.location = encodeURI(`/requests/approvedRequests`);
            }
        }));

        document.querySelectorAll(".cancel-issue-btn").forEach(x => x.addEventListener("click", () => {
            if (confirm("Are you sure want to cancel this request?")) {
                cancelRequest(x.value);
                window.location = encodeURI(`/requests/approvedRequests`);
            }
        }));

    });

    window.addEventListener("load", () => populateRequests(document.querySelector(".request-table .table-body"), "", "approved"))
</script>

{% endblock %}